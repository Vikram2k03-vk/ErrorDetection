name: XML Error Detection

on:
  pull_request:
    paths:
      - '**/*.xml'

jobs:
  validate-xml:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build validator Docker image
        run: docker build -t xml-validator .github/docker/xml-validator

      - name: Find all XML files
        id: xml-files
        run: |
          echo "files=$(find . -type f -name '*.xml' | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Run validation inside Docker
        run: |
          docker run --rm -v "$PWD:/workspace" -w /workspace xml-validator bash -c '
            set -e
            ERROR=0
            echo "üß™ Validating XML files..."
            for file in ${{ steps.xml-files.outputs.files }}; do
              echo "üîç Checking $file"
              if ! xmllint --noout "$file"; then
                echo "‚ùå Invalid XML (xmllint): $file"
                ERROR=1
              fi
              if ! xmlstarlet val -e -s "$file"; then
                echo "‚ùå Invalid XML (xmlstarlet): $file"
                ERROR=1
              fi
            done

            if [ "$ERROR" -ne 0 ]; then
              echo "‚ùå XML validation failed."
              exit 1
            else
              echo "‚úÖ All XML files passed validation."
            fi
          '
